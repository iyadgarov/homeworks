## Дипломная работа професии «Системный администратор»
## Ядгаров Ильхом Мухамадович - SYS-21 -

Согласно задачам, была разработана отказоустойчивая инфраструктура для сайта, включающая мониторинг, сбор логов и резервное копирование данных.
Все исходники находятся в корне /DIPLOM и /DIPLOM/roles

**С помощью Terraform создаём инфраструктуру.**

•	Создаём две виртуальные машины для http веб-серверов со следующими характеристиками: Ubuntu/ram-4Gb/hdd-10Gb, абсолютно идентичных, расположенных в разных зонах;  
•	Создаём одну виртуальную машину “bastion” с доступом только через ssh с характеристиками: Ubuntu/ram-4Gb/hdd-10Gb;  
•	Создаём три виртуальные машины для организации систем мониторинга (Zabbix посредством zabbix-agent) и сбора лог-файлов с виртуальных машин (Elasticsearch посредством Filebeat и сервер Kibana) с характеристиками: Debian/ram-8Gb/hdd-15;  
•	Создаём отказоустойчивую инфраструктуру для сайта: Target и Backend группы, http роутер, балансировщик нагрузки для веб-серверов;  
•	Настраиваем сеть, с подсетями в разных зонах с соответствующими группами безопасности для виртуальных машин и сервисов;  
•	Организовываем резервное копирование данных, путём снятия snapshot дисков всех виртуальных машин с определённой периодичностью.  

**С помощью Ansible настраиваем созданные виртуальные машины.**

•	Установка и первоначальная настройка http серверов;  
•	Установка и первоначальная настройка сервера системы мониторинга Zabbix;  
•	Установка и настройка zabbix-agent для мониторинга инфраструктуры;  
•	Установка и настройка сервера сбора логов Elasticsearch;  
•	Установка и настройка системы визуализации данных Kibana;  
•	Установка на виртуальные машины плагина для сбора и передачи логов Filebeat;  

**Terraform. Создаём инфраструктуру.**

1. Конфигурационный файл **main.tf** описывает провайдера, параметры подключения, создание сети, подсетей, вывода информации о IP адресации созданных виртуальных машинах и сервисов, а также описывает создание следующих виртуальных машин:
   •	bastion - Для реализации концепции bastion host. Для организации SSH подключений ко всем виртуальным машинам, имеет внешний IP - адрес;  
   •	web1 - веб сервер, со статической страницей. Без внешнего IP - адреса;  
   •	web2 - веб сервер, со статической страницей. Без внешнего IP - адреса;  
   •	zabbix - Для развертывания сервера мониторинга Zabbix. Имеет внешний IP - адрес;  
   •	elastic - Для организации ELK - системы сбора логов. Без внешнего IP - адреса;
    •	kibana - Веб-интерфейс для Elasticsearch. Есть внешний IP - адрес;

3. Конфигурационный файл **network.tf** описывает создание target и backeng групп, http - роутера, сервиса application load balancer для распределения трафика на веб-серверы. Так же в данном файле описывается создание Security Groups соответствующих сервисов.

4. С помощью файла **snapshot.tf** организована система резервного копирования дисков всех виртуальных машин.

После успешного запуска terraform apply в Yandex Cloud успешно развернута требуемая инфраструктура.

Скриншот виртуальных машин в браузере
![alt terra_img1.jpg](/DIPLOM/img/terra_img1.jpg)

Скриншот виртуальных машин в консоли.
![alt terra_img2.jpg](/DIPLOM/img/terra_img2.jpg)

Скриншот групп безопасности в браузере
![alt terra_img3.jpg](/DIPLOM/img/terra_img3.jpg)

Скриншот групп безопасности в консоли.
![alt terra_img4.jpg](/DIPLOM/img/terra_img4.jpg)

**Резервное копирование:**  
Скриншот снепшотов в браузере.
![alt terra_img8.jpg](/DIPLOM/img/terra_img8.jpg)


Для перехода к настройке инфраструктуры в каталоге с плейбуками ansible создаём файл hosts. В этом файле описываются параметры подключения к виртуальным машинам для работы Ansible по SSH через выделенную виртуальную машину **bastion**.

Создание файла инвентаризации  
**terraform output output-ansible-hosts > ansible/hosts**  
**cd ./ansible**  
**sed -i '1d; $d' hosts**

![alt terra_img5.jpg](/DIPLOM/img/terra_img5.jpg)

Скрин созданного файла инвентаризации
![alt terra_img6.jpg](/DIPLOM/img/terra_img6.jpg)


**Ansible. Настраиваем инфраструктуру**

Начинаем с проверки доступности всех хостов.

Вывод скриншота консоли:
![alt terra_img7.jpg](/DIPLOM/img/terra_img7.jpg)


**Настройка Веб - серверов осуществляется запуском файл-скрипта playbook1-nginx.yaml.**

В итоге: на двух виртуальных машинах развернуты и запущены HTTP-серверы Nginx, передан первоначальный набор файлов для сайта, заменён конфигурационный файл nginx.conf.

Вывод скриншота c успешным выполнением
![alt ans_nginx1.jpg](/DIPLOM/img/ans_nginx1.jpg)

Вывод скриншота броузера
![alt ans_nginx2.jpg](/DIPLOM/img/ans_nginx2.jpg)

Вывод скриншота консоли с командой curl -v ip-адрес обоих веб-серверов.
веб-1
![alt ans_nginx3.jpg](/DIPLOM/img/ans_nginx3.jpg)

веб-2
![alt ans_nginx4.jpg](/DIPLOM/img/ans_nginx4.jpg)


Файл-скрипт **playbook2-zserver.yaml** разворачивает на виртуальную машину, сервер мониторинга Zabbix и необходимое для его работы программное обеспечение, а также конфигурирует базу данных, правит конфигурационный файл zabbix_server.conf. 

Вывод скриншота c успешным выполнением.
![alt ans_zserver1.jpg](/DIPLOM/img/ans_zserver1.jpg)

Проверка статуса Zabbix сервера.
![alt ans_zserver2.jpg](/DIPLOM/img/ans_zserver2.jpg)

Файл-скрипт **playbook3-zagent.yaml** устанавливает на все виртуальные машины программное обеспечение Zabbix-agent для работы с сервером Zabbix, правит конфигурационный файл zabbix_agentd.conf. 

Вывод скриншота c успешным выполнением.
![alt ans_zagent1.jpg](/DIPLOM/img/ans_zagent1.jpg)

Проверяем статус службы Zabbix-agent на всех виртуальных машинах.
![alt ans_zagent2.jpg](/DIPLOM/img/ans_zagent2.jpg)

После установки необходимого программного обеспечения, можно приступать к настройке отображения нужной информации в веб - интерфейсе сервера Zabbix:

Скриншот успешной настройки.
![alt konf_zserver1.jpg](/DIPLOM/img/konf_zserver1.jpg)

Скриншот установка успешно закончена.
![alt konf_zserver2.jpg](/DIPLOM/img/konf_zserver2.jpg)

Скриншот: Список хостов.
![alt konf_zserver3.jpg](/DIPLOM/img/konf_zserver3.jpg)

Скриншот: Dashboard-Data
![alt konf_zserver4.jpg](/DIPLOM/img/konf_zserver4.jpg)

Скриншот: Dashboard for NGINXs
![alt konf_zserver5.jpg](/DIPLOM/img/konf_zserver5.jpg)


Файл-скрипт **playbook4-elastic.yaml**  разворачивает сервер elasticsearch. Так как этот сервис работает в Docker - контейнере, устанавливается docker и необходимые для него пакеты. 

Вывод скриншота c успешным выполнением.
![alt ans_elastic1.jpg](/DIPLOM/img/ans_elastic1.jpg)

Скриншот c проверкой доступности сервера:  curl -v http://10.1.1.101:9200
![alt ans_elastic2.jpg](/DIPLOM/img/ans_elastic2.jpg)

Файл-скрипт **playbook5-kibana.yml**  разворачивает контейнер Docker c Kibana (веб-интерфейс для Elasticsearch). Устанавливается docker и неоходимые для него пакеты. 

Вывод скриншота c успешным выполнением.
![alt ans_kibana1.jpg](/DIPLOM/img/ans_kibana1.jpg)

Файл-скрипт **playbook6-filebeat.yaml** устанавливает, настраивает и запускает программное обеспечение filebeat на ВМ с веб - серверами. Конфигурация настроена на отправку access.log, error.log nginx в Elasticsearch. Пакет filebeat-8.11.1-amd64.deb заливается на веб - серверы с машины Ansible. 

Вывод скриншота c успешным выполнением.
![alt ans_filebeat1.jpg](/DIPLOM/img/ans_filebeat1.jpg)

Скриншота броузера с Кибаной.
![alt ans_kibana2.jpg](/DIPLOM/img/ans_kibana2.jpg)


Спасибо.
